<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Account â€” Journey Apparel</title>
    <meta name="description" content="Your Journey Apparel account." />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        margin: 0;
        background: #fff;
        color: #111;
      }
      header.header {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        background: #fff;
        z-index: 500;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
      }
      header .header-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
      }
      .logo a {
        text-decoration: none;
        color: #111;
        letter-spacing: 1.8px;
        font-weight: 900;
      }
      .icon-btn {
        text-decoration: none;
        color: #111;
        font-size: 18px;
      }
      main.container {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 64px;
      }
      .card {
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
        padding: 24px;
        background: #fff;
      }
      .btn {
        display: inline-block;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #111;
        background: #111;
        color: #fff;
        font-weight: 700;
        text-decoration: none;
      }
      .btn.secondary {
        background: #fff;
        color: #111;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      footer {
        background: #fff;
        color: #111;
        border-top: 1px solid #333;
        padding: 24px 0;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <div class="nav-left">
          <a href="/index.html" class="logo" aria-label="Journeys Apparel Home"
            ><span>JOURNEYS</span></a
          >
        </div>
        <div class="nav-right">
          <a
            id="headerProfileLink"
            class="icon-btn"
            aria-label="Account"
            href="/account.html"
            >ðŸ‘¤</a
          >
        </div>
      </div>
    </header>

    <main class="container">
      <section id="account-card" class="card" aria-label="Account"></section>
    </main>

    <footer>
      <div style="max-width: 1200px; margin: 0 auto; padding: 0 16px">
        <span style="font-size: 14px"
          >Â© 2025 Journey Apparel. All rights reserved.</span
        >
      </div>
    </footer>

    <script src="data/products.js" defer></script>
    <script src="assets/account.js" defer></script>
    <script>
      (function () {
        function onReady(fn) {
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", fn);
          } else {
            fn();
          }
        }
        function render() {
          var url = new URL(window.location.href);
          var fromShopify =
            document.referrer &&
            document.referrer.indexOf("accounts.shopify.com") !== -1;
          if (url.searchParams.get("logged_in") === "1" || fromShopify) {
            try {
              localStorage.setItem("ja_logged_in", "true");
            } catch (e) {}
          }
          var signedIn = false;
          try {
            signedIn = localStorage.getItem("ja_logged_in") === "true";
          } catch (e) {}
          var card = document.getElementById("account-card");
          if (!card) return;
          if (signedIn) {
            var user = null;
            try {
              if (window.JAAccount && JAAccount.getUser)
                user = JAAccount.getUser();
            } catch (e) {}
            var email = user && user.email ? user.email : "";
            card.innerHTML = `
              <h1 class="upper" style="margin:0 0 8px; font-size:26px; font-weight:900; letter-spacing:0.5px;">Account</h1>
              <p data-email-line style="margin:0 16px 20px 0; color:#666;">You're signed in${
                email
                  ? ' as <strong style="color:#111"\>' + email + "</strong>"
                  : "."
              }</p>
              <div class="actions" style="margin-bottom:8px">
                <a class="btn secondary" href="/rewards.html">Rewards</a>
                <a class="btn secondary" target="_blank" rel="noopener" href="https://shopify.com/94836293942/account/orders">Orders</a>
                <a id="signOutLink" class="btn" href="https://shopify.com/94836293942/account/logout?return_url=https://journeysapparel.com/">Sign out</a>
              </div>
              <p id="pointsLine" style="margin:0 0 16px; color:#666;">Points: <strong id="pointsBalance">â€”</strong></p>
              <div class="card" style="border-radius:8px; padding:16px; border:1px solid #eee; margin-bottom:12px;">
                <h2 class="upper" style="margin:0 0 8px; font-size:18px; font-weight:800; letter-spacing:0.5px;">Recent orders</h2>
                <div id="ordersPreview" style="color:#666;">Loading your recent ordersâ€¦</div>
                <div style="margin-top:12px"><a class="btn secondary" target="_blank" rel="noopener" href="https://shopify.com/94836293942/account/orders">View all orders</a></div>
              </div>
              <div class="card" style="border-radius:8px; padding:16px; border:1px solid #eee;">
                <h2 class="upper" style="margin:0 0 8px; font-size:18px; font-weight:800; letter-spacing:0.5px;">Settings</h2>
                <p id="settingsLine" style="margin:0; color:#666;">Manage your account details from your Shopify account.${
                  email
                    ? ' Current email: <strong style="color:#111"\>' +
                      email +
                      "</strong>."
                    : ""
                }</p>
              </div>`;
            var out = card.querySelector("#signOutLink");
            // Fetch profile email (if backend is configured or in mock mode)
            try {
              fetch("/.netlify/functions/account-me", {
                credentials: "include",
              })
                .then(function (r) {
                  return r.json().then(function (j) {
                    return { ok: r.ok, status: r.status, body: j };
                  });
                })
                .then(function (res) {
                  if (!res.ok) return;
                  var em =
                    res.body &&
                    (res.body.email || (res.body.data && res.body.data.email));
                  if (em) {
                    var p = card.querySelector("[data-email-line]");
                    if (p)
                      p.innerHTML =
                        'You\'re signed in as <strong style="color:#111">' +
                        em +
                        "</strong>";
                    var s = card.querySelector("#settingsLine");
                    if (s)
                      s.innerHTML =
                        'Manage your account details from your Shopify account. Current email: <strong style="color:#111">' +
                        em +
                        "</strong>.";
                  }
                })
                .catch(function () {});
            } catch (e) {}

            // Fetch recent orders (mock or live)
            try {
              fetch("/.netlify/functions/account-orders?limit=5", {
                credentials: "include",
              })
                .then(function (r) {
                  return r.json().then(function (j) {
                    return { ok: r.ok, status: r.status, body: j };
                  });
                })
                .then(function (res) {
                  var box = card.querySelector("#ordersPreview");
                  if (!box) return;
                  if (
                    !res.ok ||
                    !res.body ||
                    !Array.isArray(res.body.orders) ||
                    res.body.orders.length === 0
                  ) {
                    box.innerHTML = "No recent orders found.";
                    return;
                  }
                  var html =
                    '<ul style="list-style:none; padding:0; margin:0">' +
                    res.body.orders
                      .map(function (o) {
                        var date = (o.processedAt || "").split("T")[0];
                        var total = o.totalPrice
                          ? o.totalPrice.amount +
                            " " +
                            o.totalPrice.currencyCode
                          : "";
                        return (
                          '<li style="padding:8px 0; border-bottom:1px solid #eee">' +
                          "<strong>" +
                          (o.name || "Order") +
                          "</strong> Â· " +
                          date +
                          (total ? " Â· " + total : "") +
                          (o.statusUrl
                            ? ' Â· <a target="_blank" rel="noopener" href="' +
                              o.statusUrl +
                              '">View</a>'
                            : "") +
                          "</li>"
                        );
                      })
                      .join("") +
                    "</ul>";
                  box.innerHTML = html;
                })
                .catch(function () {});
            } catch (e) {}

            // Fetch rewards points (placeholder)
            try {
              fetch("/.netlify/functions/loyalty-points")
                .then(function (r) {
                  return r.json();
                })
                .then(function (j) {
                  var el = card.querySelector("#pointsBalance");
                  if (el && j && typeof j.balance !== "undefined")
                    el.textContent = j.balance;
                })
                .catch(function () {});
            } catch (e) {}

            if (out)
              out.addEventListener("click", function () {
                try {
                  localStorage.removeItem("ja_logged_in");
                } catch (e) {}
              });
          } else {
            card.innerHTML = `
              <h1 class="upper" style="margin:0 0 8px; font-size:26px; font-weight:900; letter-spacing:0.5px;">Account</h1>
              <p style="margin:0 0 16px; color:#666;">Sign in to view your orders and rewards.</p>
              <div class="actions">
                <a class="btn" href="https://shopify.com/94836293942/account/login?return_url=https://journeysapparel.com/?logged_in=1">Sign in / Join</a>
              </div>`;
          }
          if (window.JAAccount && JAAccount.setHeaderProfileLink)
            JAAccount.setHeaderProfileLink();
        }
        onReady(render);
      })();
    </script>
  </body>
</html>
