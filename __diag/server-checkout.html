<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Server Checkout Diagnostics</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; padding: 20px; }
      .row { margin: 12px 0; }
      input, button { padding: 10px 12px; font-size: 14px; }
      button { cursor: pointer; }
      pre { background: #f7f7f7; padding: 12px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <h1>Server Checkout Diagnostics</h1>

    <div class="row">
      <label>Variant GID</label><br />
      <input id="variantId" placeholder="gid://shopify/ProductVariant/########" style="min-width: 480px" />
    </div>

    <div class="row">
      <label>Quantity</label><br />
      <input id="qty" type="number" value="1" min="1" />
    </div>

    <div class="row">
      <button id="run">Create checkout (302)</button>
      <button id="open" disabled>Open checkout</button>
    </div>

    <div class="row">
      <pre id="log"></pre>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let lastLocation = null;

      function log(obj) {
        $("log").textContent = JSON.stringify(obj, null, 2);
      }

      $("run").addEventListener("click", async () => {
        $("open").disabled = true;
        lastLocation = null;
        log({ status: "Posting to /.netlify/functions/checkout" });
        try {
          const variantId = $("variantId").value.trim();
          const qty = Math.max(1, parseInt($("qty").value || "1", 10));
          const lines = variantId ? [{ merchandiseId: variantId, quantity: qty }] : [];

          const res = await fetch("/.netlify/functions/checkout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            redirect: "manual",
            body: JSON.stringify({ countryCode: "AU", lines }),
          });

          const out = { status: res.status, headers: {} };
          res.headers.forEach((v, k) => (out.headers[k] = v));

          if (res.status === 302) {
            lastLocation = res.headers.get("Location");
            out.location = lastLocation;
            $("open").disabled = !lastLocation;
          } else {
            out.body = await res.json().catch(() => ({}));
          }

          log(out);
        } catch (err) {
          log({ error: String(err && err.message || err) });
        }
      });

      $("open").addEventListener("click", () => {
        if (lastLocation) window.location.href = lastLocation;
      });
    </script>
  </body>
</html>

