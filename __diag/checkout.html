<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout Diagnostics</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        margin: 24px;
      }
      .row {
        margin: 12px 0;
      }
      input,
      button {
        padding: 10px 12px;
        font-size: 14px;
      }
      code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
      }
      .out {
        background: #fafafa;
        border: 1px solid #e5e5e5;
        padding: 12px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>Checkout Diagnostics</h1>
    <p>
      This page helps validate the Storefront Cart API checkout flow end-to-end.
    </p>

    <div class="row">
      <label>Variant GID (in-stock):</label>
      <input
        id="variantId"
        type="text"
        placeholder="gid://shopify/ProductVariant/XXXXXXXXXX"
        style="width: 480px"
      />
    </div>
    <div class="row">
      <label>Quantity:</label>
      <input id="qty" type="number" value="1" min="1" style="width: 120px" />
    </div>
    <div class="row">
      <button id="run">Create Cart → Add Line → Show URLs</button>
      <button id="open" disabled>Open checkout</button>
    </div>

    <div class="row out" id="output"></div>

    <script src="../data/products.js"></script>
    <script>
      (function () {
        const $ = (id) => document.getElementById(id);
        const out = $("output");
        const ctx = { cartId: null, checkoutUrl: null };

        function log(obj) {
          out.textContent = JSON.stringify(obj, null, 2);
          console.log("/__diag/checkout:", obj);
        }

        async function run() {
          const variantId = $("variantId").value.trim();
          const qty = Math.max(1, parseInt($("qty").value || "1", 10));
          if (!variantId) {
            alert("Please enter a valid Product Variant GID.");
            return;
          }
          try {
            // 1) Create cart (buyerIdentity AU)
            const cartRes = await window.shopifyAPI.createCart([], {
              countryCode: "AU",
            });
            ctx.cartId = cartRes?.cart?.id || null;
            // 2) Add a single known line
            const addRes = await window.shopifyAPI.addToCart(ctx.cartId, [
              { merchandiseId: variantId, quantity: qty },
            ]);
            ctx.checkoutUrl = addRes?.cart?.checkoutUrl || null;
            const shop = (function () {
              try {
                return ctx.checkoutUrl
                  ? new URL(ctx.checkoutUrl).hostname
                  : null;
              } catch (_) {
                return null;
              }
            })();
            log({ shop, cartId: ctx.cartId, checkoutUrl: ctx.checkoutUrl });
            $("open").disabled = !ctx.checkoutUrl;
          } catch (err) {
            console.error("Diagnostics failed:", err);
            log({ error: String((err && err.message) || err) });
            $("open").disabled = true;
          }
        }

        async function openCheckout() {
          if (!ctx.checkoutUrl) return;
          window.location.href = ctx.checkoutUrl; // exact string from Shopify
        }

        $("run").addEventListener("click", run);
        $("open").addEventListener("click", openCheckout);
      })();
    </script>
  </body>
</html>
